{% extends 'base.html' %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='sub.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}

<!-- section_1 -->
<div class="section_1 mb-4">
    <img src="{{ url_for('static', filename='image/main_3.png') }}"
         alt="slider1">
    <div class="carousel-caption text-white" style="top: 50%; transform: translateY(-50%);">
        <h1 class="gagu-mall-title" style="font-family: 'Libre Bodoni', serif;">GAGU MALL</h1>
    </div>
</div>

<!-- 섹션_cb: 전체 타이틀과 검색창 -->
<div class="section_cb">
    <!-- 상단 타이틀/검색 -->
    <nav class="navbar navbar-light py-2 mb-0">
        <div class="container-fluid">
            <div class="d-flex align-items-center justify-content-between w-100">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 fw-bold">ALL</h5>
                </div>
                <div class="flex-grow-1 ms-4">
                    <form class="d-flex" role="search" style="max-width: 400px; margin-left: auto;" method="GET">
                        <input
                                class="form-control me-2"
                                type="search"
                                name="search"
                                placeholder="가구 이름을 검색하세요"
                                aria-label="Search"
                                value="{{ request.args.get('search', '') }}"
                        >
                        <!-- 선택된 스타일 유지 -->
                        {% for style in selected_styles %}
                        <input type="hidden" name="style" value="{{ style }}">
                        {% endfor %}
                        <!-- 선택된 브랜드 유지 -->
                        {% for brand in selected_brands %}
                        <input type="hidden" name="brand" value="{{ brand }}">
                        {% endfor %}
                        <!-- 선택된 정렬 유지 -->
                        {% if current_sort and current_sort != 'default' %}
                        <input type="hidden" name="sort" value="{{ current_sort }}">
                        {% endif %}
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <!-- sub nav -->
    <nav class="navbar navbar-expand-lg navbar-light py-2 mb-0">
        <div class="container-fluid">
            <div class="d-flex align-items-center w-100 flex-wrap gap-2">
                <div class="d-flex align-items-center flex-grow-1 flex-wrap gap-2">

                    <!-- style dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" id="styleDropdown"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-palette"></i> 스타일
                            {% if selected_styles %}
                            <span class="badge bg-dark ms-1">{{ selected_styles|length }}</span>
                            {% endif %}
                        </button>

                        <div class="dropdown-menu p-3" style="min-width: 200px;" onclick="event.stopPropagation()">
                            <form id="styleFilterForm" method="GET">
                                <!-- 검색어 유지 -->
                                {% if request.args.get('search') %}
                                <input type="hidden" name="search" value="{{ request.args.get('search') }}">
                                {% endif %}
                                <!-- 브랜드 유지 -->
                                {% for brand in selected_brands %}
                                <input type="hidden" name="brand" value="{{ brand }}">
                                {% endfor %}
                                <!-- 정렬 유지 -->
                                {% if current_sort and current_sort != 'default' %}
                                <input type="hidden" name="sort" value="{{ current_sort }}">
                                {% endif %}

                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="modern" name="style" value="모던"
                                           {% if '모던' in selected_styles %}checked{% endif %}>
                                    <label class="form-check-label" for="modern">모던</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="natural" name="style"
                                           value="내추럴" {% if '내추럴' in selected_styles %}checked{% endif %}>
                                    <label class="form-check-label" for="natural">내추럴</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="wood" name="style" value="우드" {%
                                           if '우드' in selected_styles %}checked{% endif %}>
                                    <label class="form-check-label" for="wood">우드</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="midcentury" name="style"
                                           value="미드센추리" {% if '미드센추리' in selected_styles %}checked{% endif %}>
                                    <label class="form-check-label" for="midcentury">미드센추리</label>
                                </div>

                                <div class="d-flex gap-2 mt-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm flex-fill"
                                            onclick="resetStyleFilter()">취소
                                    </button>
                                    <button type="submit" class="btn btn-dark btn-sm flex-fill">확인</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- brand dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" id="brandDropdown"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-tag"></i> 브랜드
                            {% if selected_brands %}
                            <span class="badge bg-dark ms-1">{{ selected_brands|length }}</span>
                            {% endif %}
                        </button>

                        <div class="dropdown-menu p-0" style="min-width: 250px;" onclick="event.stopPropagation()">
                            <form id="brandFilterForm" method="GET"
                                  style="display: flex; flex-direction: column; max-height: 450px;">
                                <!-- 검색어 유지 -->
                                {% if request.args.get('search') %}
                                <input type="hidden" name="search" value="{{ request.args.get('search') }}">
                                {% endif %}
                                <!-- 스타일 유지 -->
                                {% for style in selected_styles %}
                                <input type="hidden" name="style" value="{{ style }}">
                                {% endfor %}
                                <!-- 정렬 유지 -->
                                {% if current_sort and current_sort != 'default' %}
                                <input type="hidden" name="sort" value="{{ current_sort }}">
                                {% endif %}

                                <!-- 스크롤 가능한 브랜드 리스트 영역 -->
                                <div style="overflow-y: auto; padding: 12px 16px; max-height: 350px;">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="coldfog" name="brand"
                                               value="콜드 포그" {% if '콜드 포그' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="coldfog">콜드 포그</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="britta" name="brand"
                                               value="브리타 스웨덴" {% if '브리타 스웨덴' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="britta">브리타 스웨덴</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="odo" name="brand"
                                               value="오도코펜하겐" {% if '오도코펜하겐' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="odo">오도코펜하겐</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="lnc" name="brand"
                                               value="엘엔씨스텐달" {% if '엘엔씨스텐달' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="lnc">엘엔씨스텐달</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="muller" name="brand"
                                               value="뮬러" {% if '뮬러' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="muller">뮬러</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="nuki" name="brand"
                                               value="누키" {% if '누키' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="nuki">누키</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="moll" name="brand" value="몰"
                                               {% if '몰' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="moll">몰</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="muuto" name="brand"
                                               value="무토" {% if '무토' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="muuto">무토</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="brionvega" name="brand"
                                               value="브리온베가" {% if '브리온베가' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="brionvega">브리온베가</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="flos" name="brand"
                                               value="플로스" {% if '플로스' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="flos">플로스</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="artemide" name="brand"
                                               value="아르떼미데" {% if '아르떼미데' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="artemide">아르떼미데</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="borderbar" name="brand"
                                               value="보더바" {% if '보더바' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="borderbar">보더바</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="alias" name="brand"
                                               value="알리아스" {% if '알리아스' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="alias">알리아스</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="spectrum" name="brand"
                                               value="스펙트럼" {% if '스펙트럼' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="spectrum">스펙트럼</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="tecta" name="brand"
                                               value="텍타" {% if '텍타' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="tecta">텍타</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="martinelli" name="brand"
                                               value="마르티넬리 루체" {% if '마르티넬리 루체' in selected_brands %}checked{% endif
                                        %}>
                                        <label class="form-check-label" for="martinelli">마르티넬리 루체</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="magis" name="brand"
                                               value="마지스" {% if '마지스' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="magis">마지스</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="oluce" name="brand"
                                               value="올루체" {% if '올루체' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="oluce">올루체</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="desede" name="brand"
                                               value="드세데" {% if '드세데' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="desede">드세데</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="out" name="brand" value="아웃"
                                               {% if '아웃' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="out">아웃</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="anglepoise" name="brand"
                                               value="앵글포이즈" {% if '앵글포이즈' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="anglepoise">앵글포이즈</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="foscarini" name="brand"
                                               value="포스카리니" {% if '포스카리니' in selected_brands %}checked{% endif %}>
                                        <label class="form-check-label" for="foscarini">포스카리니</label>
                                    </div>
                                </div>

                                <!-- 하단 고정 버튼 영역 -->
                                <div style="border-top: 1px solid #dee2e6; padding: 12px 16px; background-color: white;">
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-secondary btn-sm flex-fill"
                                                onclick="resetBrandFilter()">취소
                                        </button>
                                        <button type="submit" class="btn btn-dark btn-sm flex-fill">확인</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- sort dropdown -->
                    <div class="dropdown ms-auto">
                        <button class="btn btn-light dropdown-toggle" type="button" id="sortDropdown"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-funnel"></i> 정렬
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item {% if current_sort == 'default' or not current_sort %}active{% endif %}"
                                   href="?{% if request.args.get('search')
                                   %}search={{ request.args.get('search') }}
                                   &{% endif %}{% for style in selected_styles %}
                                   style={{ style }}&{% endfor %}
                                   {% for brand in selected_brands %}brand={{ brand }}&{% endfor %}sort=default">인기순</a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if current_sort == 'price_low' %}active{% endif %}"
                                   href="?{% if request.args.get('search')
                                    %}search={{ request.args.get('search') }}
                                    &{% endif %}{% for style in selected_styles %}
                                    style={{ style }}&{% endfor %}
                                    {% for brand in selected_brands %}brand={{ brand }}&{% endfor %}sort=price_low">낮은가격순</a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if current_sort == 'price_high' %}active{% endif %}"
                                   href="?{% if request.args.get('search')
                                    %}search={{ request.args.get('search') }}
                                    &{% endif %}{% for style in selected_styles %}
                                    style={{ style }}&{% endfor %}{% for brand in selected_brands %}
                                    brand={{ brand }}&{% endfor %}sort=price_high">높은가격순</a>
                            </li>
                            <li>
                                <a class="dropdown-item {% if current_sort == 'new' %}active{% endif %}"
                                   href="?{% if request.args.get('search')
                                   %}search={{ request.args.get('search') }}
                                   &{% endif %}{% for style in selected_styles %}
                                   style={{ style }}&{% endfor %}
                                   {% for brand in selected_brands %}brand={{ brand }}&{% endfor %}sort=new">신상품순</a>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </nav>
</div> <!-- /.section_cb -->

<!-- 선택된 필터 표시 (박스 완전히 밖) -->
{% if selected_styles or selected_brands %}
<div style="width: 100%; max-width: 1400px; margin: 0 auto -26px auto; padding: 0 80px; position: relative; z-index: 1;">
    <div style="padding: 12px 0 0 43px;">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            {% for style in selected_styles %}
            <span class="badge bg-secondary d-flex align-items-center gap-1 px-3 py-2">
              {{ style }}
              <a href="?search={{ request.args.get('search', '') }}
              {% for s in selected_styles if s != style %}&style={{ s }}{% endfor %}
              {% for b in selected_brands %}&brand={{ b }}{% endfor %}
              {% if current_sort and current_sort != 'default' %}&sort={{ current_sort }}{% endif %}"
              class="text-white text-decoration-none ms-1"
              style="cursor: pointer;"
              ><i class="bi bi-x"></i></a>
            </span>
            {% endfor %}

            {% for brand in selected_brands %}
            <span class="badge bg-primary d-flex align-items-center gap-1 px-3 py-2">
              {{ brand }}
              <a href="?search={{ request.args.get('search', '') }}
              {% for s in selected_styles %}&style={{ s }}{% endfor %}
              {% for b in selected_brands if b != brand %}&brand={{ b }}{% endfor %}
              {% if current_sort and current_sort != 'default' %}&sort={{ current_sort }}{% endif %}"
              class="text-white text-decoration-none ms-1"
              style="cursor: pointer;">
              <i class="bi bi-x"></i></a>
            </span>
            {% endfor %}

            <a href="?search={{ request.args.get('search', '') }}{% if current_sort and current_sort != 'default' %}&sort={{ current_sort }}{% endif %}"
                    class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1">
                <i class="bi bi-x-circle"></i> 초기화
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- section_2: 제품 그리드 -->
<div class="section_2">
    <div class="container-fluid">
        {% if product_list.items %}
        <!-- 제품 그리드 (5x5) -->
        <div class="product-grid">
            {% for product in product_list.items %}
            <a href="{{ url_for('product_detail', product_id=product.id) }}">
                <article class="product-card" data-id="{{ product.id }}">
                    <div class="product-image position-relative">
                        <img
                                src="{{ product.image_url }}"
                                alt="{{ product.name }}"
                                loading="lazy"
                                onerror="this.src='/static/img/placeholder.png'"
                        >
                        <button
                                class="btn btn-link position-absolute p-0 border-0 wishlist-btn"
                                style="bottom: 10px; right: 10px; background-color: rgba(255, 255, 255, 0.9); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"
                                data-product-id="{{ product.id }}"
                                onclick="toggleWishlist(event, {{ product.id }})"
                        >
                            <i class="bi bi-heart" style="font-size: 18px; color: #333;"></i>
                        </button>
                    </div>
                    <div class="product-info">
                        <p class="product-brand mb-1">{{ product.brand }}</p>
                        <h3 class="product-name">{{ product.name }}</h3>
                        <p class="product-price mb-0">{{ "{:,}".format(product.price) }}원</p>
                    </div>
                </article>
            </a>
            {% endfor %}
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination-wrapper">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center gap-1 mb-0">
                    {% if product_list.has_prev %}
                    <li class="page-item">
                        <a
                                class="page-link"
                                href="?page={{ product_list.prev_num }}{% if request.args.get('search') %}&search={{ request.args.get('search') }}{% endif %}{% for style in selected_styles %}&style={{ style }}{% endfor %}{% for brand in selected_brands %}&brand={{ brand }}{% endfor %}{% if current_sort and current_sort != 'default' %}&sort={{ current_sort }}{% endif %}"
                                aria-label="Previous"
                        ><i class="bi bi-chevron-left"></i></a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                    </li>
                    {% endif %}

                    {% set start_page = ((product_list.page - 1) // 10) * 10 + 1 %}
                    {% set end_page = [start_page + 9, product_list.pages]|min %}

                    {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == product_list.page %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                        <a
                                class="page-link"
                                href="?page={{ page_num }}{% if request.args.get('search') %}&search={{ request.args.get('search') }}{% endif %}{% for style in selected_styles %}&style={{ style }}{% endfor %}{% for brand in selected_brands %}&brand={{ brand }}{% endfor %}{% if current_sort and current_sort != 'default' %}&sort={{ current_sort }}{% endif %}"
                        >{{ page_num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if product_list.has_next %}
                    <li class="page-item">
                        <a
                                class="page-link"
                                href="?page={{ product_list.next_num }}{% if request.args.get('search') %}&search={{ request.args.get('search') }}{% endif %}{% for style in selected_styles %}&style={{ style }}{% endfor %}{% for brand in selected_brands %}&brand={{ brand }}{% endfor %}{% if current_sort and current_sort != 'default' %}&sort={{ current_sort }}{% endif %}"
                                aria-label="Next"
                        ><i class="bi bi-chevron-right"></i></a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>

        {% else %}
        <div class="text-center py-5 my-5">
            <i class="bi bi-search" style="font-size: 64px; color: #dee2e6;"></i>
            <h5 class="mt-3 text-muted">검색 결과가 없습니다</h5>
            <p class="text-muted">다른 검색어나 필터로 시도해보세요</p>
            <a href="{{ url_for('product.sub') }}" class="btn btn-outline-secondary mt-2">전체 보기</a>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='sub.js') }}"></script>
{% endblock %}
